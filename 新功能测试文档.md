# WebShop 新功能测试文档

## 测试环境准备

### 1. 数据库准备

执行以下SQL脚本：

```sql
-- 1. 创建SKU表
SOURCE web-shop-backend/src/main/resources/create_product_sku_table.sql;

-- 2. 为订单项表添加SKU字段
SOURCE web-shop-backend/src/main/resources/add_sku_id_to_order_item.sql;
```

### 2. 邮件配置

修改 `web-shop-backend/src/main/resources/application.properties`：

```properties
# 邮件配置（根据实际邮箱服务商修改）
spring.mail.host=smtp.qq.com
spring.mail.port=587
spring.mail.username=your-email@qq.com
spring.mail.password=your-authorization-code
```

**常见邮箱配置：**
- QQ邮箱：smtp.qq.com (端口587)
- 163邮箱：smtp.163.com (端口25)
- Gmail：smtp.gmail.com (端口587)

### 3. 启动服务

```bash
# 启动后端
cd web-shop-backend
mvn spring-boot:run

# 启动前端
cd web-shop-frontend
npm run dev
```

---

## 功能一：用户注册邮箱字段

### 测试目标
验证用户注册时可以填写邮箱，并正确保存到数据库。

### 测试步骤

1. **访问注册页面**
   - 打开浏览器访问：`http://localhost:5173/register`

2. **填写注册信息**
   - 用户名：`testuser001`
   - 手机号：`13800138000`
   - 邮箱：`testuser001@example.com` ⭐ 新增字段
   - 密码：`123456`
   - 确认密码：`123456`
   - 勾选用户协议

3. **提交注册**
   - 点击"注册"按钮
   - 等待提示"注册成功"

4. **验证数据库**
   ```sql
   SELECT id, username, phone, email FROM user WHERE username = 'testuser001';
   ```
   
   **预期结果：**
   - email字段应显示：`testuser001@example.com`

### 测试用例

| 测试项 | 输入 | 预期结果 |
|--------|------|----------|
| 正常邮箱 | test@example.com | 注册成功 |
| 无效邮箱 | invalid-email | 提示"请输入正确的邮箱格式" |
| 空邮箱 | (留空) | 提示"请输入邮箱" |

---

## 功能二：商家发货邮件通知

### 测试目标
验证商家确认发货后，系统自动发送邮件通知用户。

### 前置条件

1. **创建测试订单**
   - 用户登录并下单
   - 完成支付（订单状态变为"待发货"）

2. **确保用户有邮箱**
   ```sql
   UPDATE user SET email = 'your-test-email@qq.com' WHERE id = 1;
   ```

### 测试步骤

1. **管理员登录**
   - 访问：`http://localhost:5173/admin/login`
   - 使用管理员账号登录

2. **进入订单管理**
   - 点击左侧菜单"订单管理"
   - 找到状态为"待发货"的订单

3. **确认发货**
   - 点击订单的"发货"按钮
   - 填写物流信息：
     - 物流公司：`顺丰速运`
     - 物流单号：`SF1234567890`
   - 点击"确认发货"

4. **检查邮件**
   - 登录用户邮箱
   - 查看是否收到发货通知邮件

### 邮件内容示例

```
主题：订单发货通知 - ORD1699999999001

尊敬的用户：

您的订单 ORD1699999999001 已发货！

物流公司：顺丰速运
物流单号：SF1234567890

请注意查收，感谢您的购买！

此邮件为系统自动发送，请勿回复。
```

### 测试用例

| 测试项 | 条件 | 预期结果 |
|--------|------|----------|
| 用户有邮箱 | email不为空 | 发送邮件成功 |
| 用户无邮箱 | email为空 | 不发送邮件，但发货成功 |
| 邮箱配置错误 | 邮件服务器配置错误 | 记录日志，发货仍成功 |

### 故障排查

**如果未收到邮件：**

1. 检查后端日志：
   ```
   发货通知邮件发送成功：toEmail=xxx, orderNo=xxx
   或
   发货通知邮件发送失败：toEmail=xxx, orderNo=xxx, error=xxx
   ```

2. 检查邮箱配置：
   - 确认邮箱地址和授权码正确
   - 确认SMTP服务器地址和端口正确

3. 检查垃圾邮件箱

---

## 功能三：商品SKU管理

### 测试目标
验证商品可以设置多规格，每个规格有独立的价格和库存。

### 测试步骤

#### 3.1 新增带SKU的商品

1. **进入商品管理**
   - 管理员登录后，点击"商品管理"
   - 点击"新增商品"按钮

2. **填写基本信息**
   - 商品名称：`iPhone 15 Pro`
   - 商品分类：选择"手机数码"
   - 商品价格：`7999`（作为基础价格）
   - 原价：`8999`
   - 上传商品图片

3. **添加规格**
   
   **规格1：颜色**
   - 点击"添加规格"
   - 规格名称：`颜色`
   - 添加规格值：
     - 输入`黑色`，按回车
     - 输入`白色`，按回车
     - 输入`蓝色`，按回车

   **规格2：内存**
   - 再次点击"添加规格"
   - 规格名称：`内存`
   - 添加规格值：
     - 输入`128G`，按回车
     - 输入`256G`，按回车
     - 输入`512G`，按回车

4. **生成SKU**
   - 点击"生成SKU"按钮
   - 系统自动生成 3×3 = 9 个SKU组合

5. **设置SKU信息**

   | SKU组合 | 价格 | 原价 | 库存 |
   |---------|------|------|------|
   | 黑色-128G | 7999 | 8999 | 50 |
   | 黑色-256G | 8999 | 9999 | 30 |
   | 黑色-512G | 9999 | 10999 | 20 |
   | 白色-128G | 7999 | 8999 | 40 |
   | 白色-256G | 8999 | 9999 | 25 |
   | 白色-512G | 9999 | 10999 | 15 |
   | 蓝色-128G | 7999 | 8999 | 35 |
   | 蓝色-256G | 8999 | 9999 | 20 |
   | 蓝色-512G | 9999 | 10999 | 10 |

6. **查看总库存**
   - 在"库存数量"字段应显示：`245 件（由SKU库存自动计算）`
   - 计算：50+30+20+40+25+15+35+20+10 = 245

7. **提交保存**
   - 点击"提交新增"按钮
   - 等待提示"新增成功"

#### 3.2 验证数据库

```sql
-- 查看商品信息
SELECT id, name, price, stock FROM product WHERE name = 'iPhone 15 Pro';

-- 查看SKU信息
SELECT 
    sku_name, 
    price, 
    original_price, 
    stock 
FROM product_sku 
WHERE product_id = (SELECT id FROM product WHERE name = 'iPhone 15 Pro')
ORDER BY id;
```

**预期结果：**
- product表：stock = 245
- product_sku表：9条记录，每条有独立的价格和库存

#### 3.3 编辑SKU

1. **进入编辑页面**
   - 在商品列表找到刚创建的商品
   - 点击"编辑"按钮

2. **修改SKU库存**
   - 将"黑色-128G"的库存改为 `100`
   - 观察总库存自动更新为：`295 件`

3. **保存修改**
   - 点击"保存修改"
   - 验证数据库中的库存已更新

### 测试用例

| 测试场景 | 操作 | 预期结果 |
|----------|------|----------|
| 单规格商品 | 只添加1个规格（如颜色：红、蓝） | 生成2个SKU |
| 双规格商品 | 添加2个规格（颜色×尺寸） | 生成笛卡尔积组合 |
| 三规格商品 | 添加3个规格 | 生成所有组合 |
| 修改SKU库存 | 修改任意SKU库存 | 总库存实时更新 |
| 删除规格值 | 删除某个规格值 | 重新生成SKU时不包含该值 |

---

## 功能四：SKU库存自动计算

### 测试目标
验证商品总库存由SKU库存自动计算，无需手动输入。

### 测试步骤

1. **新增商品时**
   - 添加规格并生成SKU
   - 确认"库存数量"字段不可编辑
   - 显示为只读文本

2. **修改SKU库存**
   - 修改任意SKU的库存数量
   - 观察总库存立即更新

3. **计算验证**
   ```
   SKU1: 50件
   SKU2: 30件
   SKU3: 40件
   总库存 = 50 + 30 + 40 = 120件
   ```

### 边界测试

| 测试项 | 操作 | 预期结果 |
|--------|------|----------|
| 所有SKU库存为0 | 设置所有SKU库存=0 | 总库存=0 |
| 单个SKU大库存 | 设置SKU库存=9999 | 总库存正确计算 |
| 删除所有SKU | 删除所有规格 | 库存字段隐藏 |

---

## 集成测试场景

### 场景1：完整购物流程

1. **用户注册**（带邮箱）
2. **浏览商品**（查看SKU商品）
3. **选择规格**（选择具体SKU）
4. **加入购物车**
5. **下单支付**
6. **商家发货**（触发邮件）
7. **用户收货**

### 场景2：库存扣减

1. **创建SKU商品**（某SKU库存10件）
2. **用户下单**（购买该SKU 3件）
3. **验证库存**
   - SKU库存：10 - 3 = 7
   - 商品总库存相应减少

### 场景3：多规格商品展示

1. **前端商品详情页**
2. **显示所有规格选项**
3. **选择不同规格**
4. **价格和库存动态变化**

---

## 性能测试

### 测试项目

1. **大量SKU生成**
   - 3个规格，每个10个值
   - 生成1000个SKU
   - 测试生成速度和保存时间

2. **并发发货**
   - 同时发货10个订单
   - 测试邮件发送性能

3. **库存计算**
   - 100个SKU的商品
   - 测试库存计算响应时间

---

## 常见问题排查

### 问题1：邮件发送失败

**症状：** 发货后未收到邮件

**排查步骤：**
1. 检查后端日志中的错误信息
2. 验证邮箱配置是否正确
3. 测试邮箱服务器连接
4. 检查用户是否有邮箱地址

### 问题2：SKU未生成

**症状：** 点击"生成SKU"无反应

**排查步骤：**
1. 检查是否已添加规格
2. 检查规格是否有值
3. 查看浏览器控制台错误
4. 检查后端日志

### 问题3：库存计算错误

**症状：** 总库存与SKU库存之和不符

**排查步骤：**
1. 刷新页面重新计算
2. 检查是否有SKU库存为空
3. 查看数据库中的实际值
4. 重新生成SKU

---

## 测试检查清单

### 用户注册邮箱
- [ ] 邮箱字段显示正常
- [ ] 邮箱格式验证正确
- [ ] 邮箱保存到数据库
- [ ] 必填验证生效

### 发货邮件通知
- [ ] 邮件配置正确
- [ ] 发货触发邮件发送
- [ ] 邮件内容正确
- [ ] 用户收到邮件
- [ ] 无邮箱用户不影响发货

### SKU管理
- [ ] 规格添加正常
- [ ] SKU生成正确
- [ ] SKU编辑功能正常
- [ ] SKU保存到数据库
- [ ] SKU查询正常

### 库存计算
- [ ] 总库存自动计算
- [ ] 修改SKU库存实时更新
- [ ] 库存字段只读
- [ ] 计算结果准确

---

## 测试报告模板

```markdown
## 测试报告

**测试日期：** 2025-11-10
**测试人员：** [姓名]
**测试环境：** 开发环境

### 测试结果汇总

| 功能模块 | 测试用例数 | 通过 | 失败 | 通过率 |
|----------|-----------|------|------|--------|
| 用户注册邮箱 | 3 | 3 | 0 | 100% |
| 发货邮件通知 | 3 | 3 | 0 | 100% |
| SKU管理 | 5 | 5 | 0 | 100% |
| 库存自动计算 | 3 | 3 | 0 | 100% |

### 发现的问题

1. [问题描述]
   - 严重程度：高/中/低
   - 复现步骤：
   - 预期结果：
   - 实际结果：

### 测试结论

- [ ] 所有功能正常，可以上线
- [ ] 存在问题，需要修复后重新测试
```

---

## 附录

### A. 测试数据

```sql
-- 测试用户
INSERT INTO user (username, phone, email, password, role, status) 
VALUES ('testuser', '13800138000', 'test@example.com', MD5('123456'), 'user', 1);

-- 测试商品分类
INSERT INTO product_category (name, parent_id, level, sort_order, status)
VALUES ('手机数码', 0, 1, 1, 1);
```

### B. API测试（Postman）

**发货接口：**
```
PUT http://localhost:8080/api/orders/{orderNo}/ship
Content-Type: application/json

{
  "expressCompany": "顺丰速运",
  "trackingNo": "SF1234567890"
}
```

**SKU查询接口：**
```
GET http://localhost:8080/api/product-sku/product/{productId}
```

---

**测试完成后，请填写测试报告并提交！**