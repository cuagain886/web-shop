<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.javaweb.webshopbackend.mapper.OrderItemMapper">

    <!-- 查询订单的所有订单项 -->
    <select id="selectByOrderId" resultType="org.javaweb.webshopbackend.pojo.entity.OrderItem">
        SELECT
            id,
            order_id,
            product_id,
            sku_id,
            product_name,
            product_image,
            unit_price,
            quantity,
            total_price,
            spec_info,
            is_reviewed
        FROM `order_item`
        WHERE order_id = #{orderId}
        ORDER BY id ASC
    </select>

    <!-- 查询用户待评价的订单项 -->
    <select id="selectUnreviewedByUserId" resultType="org.javaweb.webshopbackend.pojo.entity.OrderItem">
        SELECT
            oi.id,
            oi.order_id,
            oi.product_id,
            oi.sku_id,
            oi.product_name,
            oi.product_image,
            oi.unit_price,
            oi.quantity,
            oi.total_price,
            oi.spec_info,
            oi.is_reviewed,
            o.order_no AS orderNo
        FROM `order_item` oi
        INNER JOIN `orders` o ON oi.order_id = o.id
        INNER JOIN `user` u ON o.user_id = u.id AND u.deleted = 0
        WHERE o.user_id = #{userId}
        AND o.status = 4  -- 已完成
        AND NOT EXISTS (
            SELECT 1 FROM `product_review` pr
            WHERE pr.order_item_id = oi.id
        )
        ORDER BY oi.id DESC
    </select>

    <!-- 查询用户已评价的订单项 -->
    <select id="selectReviewedByUserId" resultType="org.javaweb.webshopbackend.pojo.entity.OrderItem">
        SELECT
            oi.id,
            oi.order_id,
            oi.product_id,
            oi.sku_id,
            oi.product_name,
            oi.product_image,
            oi.unit_price,
            oi.quantity,
            oi.total_price,
            oi.spec_info,
            oi.is_reviewed
        FROM `order_item` oi
        INNER JOIN `orders` o ON oi.order_id = o.id
        INNER JOIN `user` u ON o.user_id = u.id AND u.deleted = 0
        WHERE o.user_id = #{userId}
        AND EXISTS (
            SELECT 1 FROM `product_review` pr
            WHERE pr.order_item_id = oi.id
        )
        ORDER BY oi.id DESC
    </select>

    <!-- 统计商品销售数据（用于销售排行） -->
    <select id="selectProductSalesRanking" resultType="org.javaweb.webshopbackend.pojo.entity.OrderItem">
        SELECT
            product_id,
            product_name,
            product_image,
            SUM(quantity) AS quantity,
            SUM(price * quantity) AS price  -- 使用price字段存储总销售额
        FROM `order_item` oi
        INNER JOIN `orders` o ON oi.order_id = o.id
        WHERE o.status IN (2, 3, 4)  -- 已支付、已发货、已完成
        GROUP BY product_id, product_name, product_image
        ORDER BY quantity DESC
        LIMIT #{limit}
    </select>

</mapper>

