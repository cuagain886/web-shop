<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.javaweb.webshopbackend.mapper.OrdersMapper">

    <!-- 订单ResultMap（包含订单项） -->
    <resultMap id="OrdersWithItemsMap" type="org.javaweb.webshopbackend.pojo.entity.Orders">
        <id column="id" property="id"/>
        <result column="order_no" property="orderNo"/>
        <result column="user_id" property="userId"/>
        <result column="receiver_name" property="receiverName"/>
        <result column="receiver_phone" property="receiverPhone"/>
        <result column="receiver_address" property="receiverAddress"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="pay_amount" property="payAmount"/>
        <result column="freight" property="freight"/>
        <result column="status" property="status"/>
        <result column="payment_method" property="paymentMethod"/>
        <result column="pay_time" property="payTime"/>
        <result column="ship_time" property="shipTime"/>
        <result column="receive_time" property="receiveTime"/>
        <result column="cancel_time" property="cancelTime"/>
        <result column="cancel_reason" property="cancelReason"/>
        <result column="express_company" property="expressCompany"/>
        <result column="tracking_no" property="trackingNo"/>
        <result column="note" property="note"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <!-- 订单项集合 -->
        <collection property="items" 
                    javaType="java.util.List" 
                    ofType="org.javaweb.webshopbackend.pojo.entity.OrderItem">
            <id column="item_id" property="id"/>
            <result column="item_order_id" property="orderId"/>
            <result column="item_product_id" property="productId"/>
            <result column="item_product_name" property="productName"/>
            <result column="item_product_image" property="productImage"/>
            <result column="item_price" property="unitPrice"/>
            <result column="item_quantity" property="quantity"/>
            <result column="item_spec_info" property="specInfo"/>
        </collection>
    </resultMap>

    <!-- 分页查询用户订单（带订单项） -->
    <select id="selectPageWithItems" resultMap="OrdersWithItemsMap">
        SELECT
            o.id,
            o.order_no,
            o.user_id,
            o.receiver_name,
            o.receiver_phone,
            o.receiver_address,
            o.total_amount,
            o.pay_amount,
            o.freight,
            o.status,
            o.payment_method,
            o.pay_time,
            o.ship_time,
            o.receive_time,
            o.cancel_time,
            o.cancel_reason,
            o.express_company,
            o.tracking_no,
            o.note,
            o.created_time,
            o.updated_time,
            oi.id AS item_id,
            oi.order_id AS item_order_id,
            oi.product_id AS item_product_id,
            oi.product_name AS item_product_name,
            oi.product_image AS item_product_image,
            oi.unit_price AS item_price,
            oi.quantity AS item_quantity,
            oi.spec_info AS item_spec_info
        FROM `orders` o
        INNER JOIN `user` u ON o.user_id = u.id AND u.deleted = 0
        LEFT JOIN `order_item` oi ON o.id = oi.order_id
        WHERE o.deleted = 0
          AND o.user_id = #{userId}
        <if test="status != null">
            AND o.status = #{status}
        </if>
        ORDER BY o.created_time DESC
    </select>

    <!-- 分页查询所有订单（管理端） -->
    <select id="selectAdminPage" resultMap="OrdersWithItemsMap">
        SELECT
            o.id,
            o.order_no,
            o.user_id,
            o.receiver_name,
            o.receiver_phone,
            o.receiver_address,
            o.total_amount,
            o.pay_amount,
            o.freight,
            o.status,
            o.payment_method,
            o.pay_time,
            o.ship_time,
            o.receive_time,
            o.cancel_time,
            o.cancel_reason,
            o.express_company,
            o.tracking_no,
            o.note,
            o.created_time,
            o.updated_time,
            oi.id AS item_id,
            oi.order_id AS item_order_id,
            oi.product_id AS item_product_id,
            oi.product_name AS item_product_name,
            oi.product_image AS item_product_image,
            oi.unit_price AS item_price,
            oi.quantity AS item_quantity,
            oi.spec_info AS item_spec_info
        FROM `orders` o
        LEFT JOIN `order_item` oi ON o.id = oi.order_id
        WHERE o.deleted = 0
        <if test="status != null">
            AND o.status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (o.order_no LIKE CONCAT('%', #{keyword}, '%')
                 OR o.receiver_name LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="startTime != null">
            AND o.created_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND o.created_time &lt;= #{endTime}
        </if>
        ORDER BY o.created_time DESC
    </select>

    <!-- 根据订单号查询订单（带订单项） -->
    <select id="selectByOrderNoWithItems" resultMap="OrdersWithItemsMap">
        SELECT
            o.id,
            o.order_no,
            o.user_id,
            o.receiver_name,
            o.receiver_phone,
            o.receiver_address,
            o.total_amount,
            o.pay_amount,
            o.freight,
            o.status,
            o.payment_method,
            o.pay_time,
            o.ship_time,
            o.receive_time,
            o.cancel_time,
            o.cancel_reason,
            o.express_company,
            o.tracking_no,
            o.note,
            o.created_time,
            o.updated_time,
            oi.id AS item_id,
            oi.order_id AS item_order_id,
            oi.product_id AS item_product_id,
            oi.product_name AS item_product_name,
            oi.product_image AS item_product_image,
            oi.unit_price AS item_price,
            oi.quantity AS item_quantity,
            oi.spec_info AS item_spec_info
        FROM `orders` o
        LEFT JOIN `order_item` oi ON o.id = oi.order_id
        WHERE o.deleted = 0
          AND o.order_no = #{orderNo}
    </select>

    <!-- 统计用户各状态订单数量 -->
    <select id="countByUserIdAndStatus" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM `orders` o
        INNER JOIN `user` u ON o.user_id = u.id AND u.deleted = 0
        WHERE o.deleted = 0
          AND o.user_id = #{userId}
          AND o.status = #{status}
    </select>

    <!-- 统计时间范围内的销售额 -->
    <select id="sumAmountByDateRange" resultType="java.lang.Double">
        SELECT IFNULL(SUM(total_amount), 0)
        FROM `orders`
        WHERE deleted = 0
          AND status IN (2, 3, 4)  -- 已支付、已发货、已完成
        <if test="startTime != null">
            AND created_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_time &lt;= #{endTime}
        </if>
    </select>

    <!-- 统计各状态订单数量 -->
    <select id="countByStatus" resultType="org.javaweb.webshopbackend.pojo.entity.Orders">
        SELECT
            status,
            COUNT(*) AS id  -- 使用id字段临时存储count值
        FROM `orders`
        WHERE deleted = 0
        GROUP BY status
    </select>

</mapper>

