<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.javaweb.webshopbackend.mapper.UserFavoriteMapper">

    <!-- 结果映射 - 包含商品信息 -->
    <resultMap id="FavoriteWithProductMap" type="org.javaweb.webshopbackend.pojo.entity.UserFavorite">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="productId" column="product_id"/>
        <result property="createdTime" column="created_time"/>
        <!-- 关联商品信息 -->
        <association property="product" javaType="org.javaweb.webshopbackend.pojo.entity.Product">
            <id property="id" column="product_id"/>
            <result property="name" column="product_name"/>
            <result property="coverImage" column="product_image"/>
            <result property="price" column="product_price"/>
            <result property="stock" column="product_stock"/>
            <result property="status" column="product_status"/>
        </association>
    </resultMap>

    <!-- 查询用户收藏列表（带商品信息） -->
    <select id="selectByUserIdWithProduct" resultMap="FavoriteWithProductMap">
        SELECT 
            uf.id,
            uf.user_id,
            uf.product_id,
            uf.created_time,
            p.name AS product_name,
            p.cover_image AS product_image,
            p.price AS product_price,
            p.stock AS product_stock,
            p.status AS product_status
        FROM user_favorite uf
        INNER JOIN user u ON uf.user_id = u.id AND u.deleted = 0
        LEFT JOIN product p ON uf.product_id = p.id AND p.deleted = 0
        WHERE uf.user_id = #{userId}
        ORDER BY uf.created_time DESC
    </select>

    <!-- 检查用户是否收藏了某商品 -->
    <select id="selectByUserIdAndProductId" resultType="org.javaweb.webshopbackend.pojo.entity.UserFavorite">
        SELECT 
            id,
            user_id AS userId,
            product_id AS productId,
            created_time AS createdTime
        FROM user_favorite
        WHERE user_id = #{userId} 
          AND product_id = #{productId}
    </select>

    <!-- 取消收藏（物理删除） -->
    <delete id="deleteByUserIdAndProductId">
        DELETE uf FROM user_favorite uf
        INNER JOIN user u ON uf.user_id = u.id AND u.deleted = 0
        WHERE uf.user_id = #{userId} 
          AND uf.product_id = #{productId}
    </delete>

    <!-- 清空用户收藏（物理删除） -->
    <delete id="deleteByUserId">
        DELETE uf FROM user_favorite uf
        INNER JOIN user u ON uf.user_id = u.id AND u.deleted = 0
        WHERE uf.user_id = #{userId}
    </delete>

    <!-- 统计商品被收藏次数 -->
    <select id="countByProductId" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM user_favorite
        WHERE product_id = #{productId}
    </select>

</mapper>

