# 订单定时任务实现说明

## 概述

本文档说明了订单管理系统中定时自动取消订单和自动确认收货功能的实现方案。

## 功能需求

### 1. 自动取消订单
- **触发条件**：订单创建后，如果在规定时间内未支付，系统自动取消订单
- **配置参数**：系统设置中的 `orderCancelTime`（小时）
- **恢复库存**：取消订单时自动恢复商品库存和SKU库存
- **执行频率**：每分钟检查一次

### 2. 自动确认收货
- **触发条件**：订单发货后，如果在规定时间内用户未确认收货，系统自动确认
- **配置参数**：系统设置中的 `orderConfirmTime`（天）
- **订单状态**：自动确认后订单状态变为已完成（3）
- **执行频率**：每分钟检查一次

## 实现方案

### 后端实现

#### 1. 定时任务类：[`OrderScheduledTask.java`](web-shop-backend/src/main/java/org/javaweb/webshopbackend/task/OrderScheduledTask.java)

```java
@Slf4j
@Component
public class OrderScheduledTask {
    
    @Autowired
    private OrdersService ordersService;
    
    @Autowired
    private SystemSettingsService systemSettingsService;
    
    // 自动取消未支付订单
    @Scheduled(cron = "0 * * * * ?")
    public void autoCancelUnpaidOrders() { ... }
    
    // 自动确认收货
    @Scheduled(cron = "0 * * * * ?")
    public void autoConfirmReceivedOrders() { ... }
}
```

**关键特性**：
- 使用 `@Component` 注解使其成为Spring Bean
- 使用 `@Scheduled` 注解配置定时执行
- Cron表达式 `0 * * * * ?` 表示每分钟执行一次
- 包含完整的异常处理和日志记录

#### 2. 启用定时任务：[`WebShopBackendApplication.java`](web-shop-backend/src/main/java/org/javaweb/webshopbackend/WebShopBackendApplication.java)

```java
@SpringBootApplication
@EnableScheduling
public class WebShopBackendApplication {
    // ...
}
```

**说明**：
- 添加 `@EnableScheduling` 注解启用Spring Task定时任务功能
- 无需额外配置，Spring会自动扫描 `@Scheduled` 注解

#### 3. 相关服务方法

**OrdersService.adminCancelOrder()**
- 已存在的方法，用于管理员取消订单
- 自动恢复库存
- 更新订单状态为已取消（4）

**SystemSettingsService.getSettings()**
- 获取系统设置
- 返回包含 `orderCancelTime` 和 `orderConfirmTime` 的配置

### 数据库配置

系统设置表 `system_settings` 包含以下关键字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `order_cancel_time` | INT | 自动取消订单时间（小时） |
| `order_confirm_time` | INT | 自动确认收货时间（天） |
| `default_shipping` | DECIMAL(10,2) | 默认运费 |

## 工作流程

### 自动取消订单流程

```
1. 定时任务每分钟执行一次
   ↓
2. 获取系统设置中的 orderCancelTime（如：24小时）
   ↓
3. 计算截止时间 = 当前时间 - 24小时
   ↓
4. 查询所有状态为0（待付款）且创建时间早于截止时间的订单
   ↓
5. 对每个订单执行：
   - 恢复商品库存
   - 恢复SKU库存
   - 更新订单状态为4（已取消）
   - 记录取消时间和原因
   ↓
6. 记录日志并处理异常
```

### 自动确认收货流程

```
1. 定时任务每分钟执行一次
   ↓
2. 获取系统设置中的 orderConfirmTime（如：7天）
   ↓
3. 计算截止时间 = 当前时间 - 7天
   ↓
4. 查询所有状态为2（待收货）且发货时间早于截止时间的订单
   ↓
5. 对每个订单执行：
   - 更新订单状态为3（已完成）
   - 记录确认收货时间
   ↓
6. 记录日志并处理异常
```

## 配置说明

### 系统设置配置

在管理后台的系统设置页面配置以下参数：

1. **自动取消订单时间**
   - 默认值：24小时
   - 含义：订单创建24小时后如未支付，自动取消
   - 建议值：12-48小时

2. **自动确认收货时间**
   - 默认值：7天
   - 含义：订单发货7天后如用户未确认，自动确认
   - 建议值：3-15天

### 日志配置

定时任务会输出以下日志：

```
INFO  - 开始执行自动取消未支付订单任务
INFO  - 找到 X 个需要取消的订单
INFO  - 订单已自动取消：orderId=1, orderNo=ORD1234567890
INFO  - 自动取消未支付订单任务完成
```

## 注意事项

### 1. 时区问题
- 系统使用 `LocalDateTime.now()` 获取当前时间
- 确保服务器时区设置正确
- 建议在 `application.properties` 中配置：
  ```properties
  spring.jackson.time-zone=Asia/Shanghai
  ```

### 2. 并发问题
- 定时任务在单线程中执行
- 如需多线程执行，可配置 `TaskScheduler`
- 当前实现已包含事务管理，确保数据一致性

### 3. 性能考虑
- 每分钟执行一次，对数据库压力较小
- 建议在业务低峰期执行（如凌晨2-4点）
- 可通过修改Cron表达式调整执行频率

### 4. 异常处理
- 所有异常都被捕获并记录日志
- 单个订单处理失败不影响其他订单
- 建议监控日志中的ERROR级别信息

## 测试方法

### 1. 测试自动取消订单

```bash
# 1. 创建一个订单（不支付）
# 2. 在系统设置中设置 orderCancelTime = 0（立即取消）
# 3. 等待定时任务执行（最多1分钟）
# 4. 查看订单状态是否变为4（已取消）
# 5. 验证库存是否已恢复
```

### 2. 测试自动确认收货

```bash
# 1. 创建并支付一个订单
# 2. 商家发货
# 3. 在系统设置中设置 orderConfirmTime = 0（立即确认）
# 4. 等待定时任务执行（最多1分钟）
# 5. 查看订单状态是否变为3（已完成）
```

## 故障排查

### 问题1：定时任务未执行

**原因**：
- 未添加 `@EnableScheduling` 注解
- 定时任务类未被Spring扫描

**解决**：
- 确保 `WebShopBackendApplication` 有 `@EnableScheduling` 注解
- 确保 `OrderScheduledTask` 有 `@Component` 注解
- 检查包扫描路径配置

### 问题2：订单未被取消

**原因**：
- 系统设置中 `orderCancelTime` 为null或0
- 订单状态不是0（待付款）
- 订单创建时间未超过设置的时间

**解决**：
- 在系统设置中配置 `orderCancelTime`
- 检查订单状态是否正确
- 查看日志中的警告信息

### 问题3：库存恢复失败

**原因**：
- SKU库存表不存在或数据不一致
- 订单项中SKU ID为null

**解决**：
- 检查 `product_sku` 表是否存在
- 查看日志中的警告信息
- 手动检查库存数据

## 相关文件

| 文件路径 | 说明 |
|---------|------|
| [`OrderScheduledTask.java`](web-shop-backend/src/main/java/org/javaweb/webshopbackend/task/OrderScheduledTask.java) | 定时任务类 |
| [`WebShopBackendApplication.java`](web-shop-backend/src/main/java/org/javaweb/webshopbackend/WebShopBackendApplication.java) | 应用主类 |
| [`OrdersService.java`](web-shop-backend/src/main/java/org/javaweb/webshopbackend/service/OrdersService.java) | 订单服务接口 |
| [`OrdersServiceImpl.java`](web-shop-backend/src/main/java/org/javaweb/webshopbackend/service/impl/OrdersServiceImpl.java) | 订单服务实现 |
| [`SystemSettings.java`](web-shop-backend/src/main/java/org/javaweb/webshopbackend/pojo/entity/SystemSettings.java) | 系统设置实体 |
| [`AdminSettings.vue`](web-shop-frontend/src/pages/admin/AdminSettings.vue) | 系统设置页面 |

## 总结

通过本实现方案，系统可以：

✅ 自动取消长期未支付的订单，释放库存  
✅ 自动确认收货，完成订单流程  
✅ 减少人工干预，提高运营效率  
✅ 完整的日志记录，便于问题排查  
✅ 灵活的配置参数，支持业务调整  

定时任务已完全集成到系统中，无需额外配置即可使用。
