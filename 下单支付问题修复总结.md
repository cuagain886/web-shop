# 下单支付问题修复总结

## 问题描述
1. **自动支付失败**：支付接口调用参数不正确
2. **支付金额与SKU数据不匹配**：订单金额使用商品基础价格而非SKU实际价格

## 修复内容

### 1. 修复支付流程（后端）

#### 修改 OrdersService.java
- 将 `payOrder` 返回类型从 `void` 改为 `Orders`

#### 修改 OrdersServiceImpl.java
- 修改 `payOrder` 方法返回订单对象
- 在 `createOrderFromItems` 中注入 `ProductSkuService`
- 使用SKU价格而非商品基础价格计算订单金额

#### 修改 OrdersController.java
- 修改 `payOrder` 返回类型从 `Result<Void>` 改为 `Result<Orders>`
- 返回更新后的订单对象

### 2. 修复支付流程（前端）

#### 修改 orderStore.js
- 修改 `payOrder` 方法签名：`payOrder(orderId, paymentMethod = 1)`
- 正确处理API返回的订单对象

#### 修改 Checkout.vue
- 修复支付调用：`const paidOrder = await orderStore.payOrder(order.id, paymentMethodValue)`
- 使用返回的订单对象进行页面跳转
- 确保订单项的价格和数量是正确的数值类型

### 3. 修复SKU价格计算（后端）

#### OrdersServiceImpl.java 中的 createOrderFromItems 方法
```java
// 获取SKU价格，如果没有SKU则使用商品价格
BigDecimal itemPrice = product.getPrice();
if (item.getSkuId() != null) {
    ProductSku sku = productSkuService.getById(item.getSkuId());
    if (sku != null && sku.getPrice() != null) {
        itemPrice = sku.getPrice();
    }
}
// 使用 itemPrice 而非 product.getPrice() 计算订单金额和订单项单价
```

## 修复效果

| 问题 | 修复前 | 修复后 |
|------|--------|--------|
| 支付接口调用 | ❌ 参数错误，调用失败 | ✅ 参数正确，调用成功 |
| 支付返回值 | ❌ 无订单对象 | ✅ 返回更新后的订单 |
| 订单金额计算 | ❌ 使用商品基础价格 | ✅ 使用SKU实际价格 |
| 订单项单价 | ❌ 商品基础价格 | ✅ SKU实际价格 |
| 页面跳转 | ❌ 跳转失败 | ✅ 正确跳转到订单详情 |

## 涉及文件

### 后端
- `OrdersService.java` - 接口定义
- `OrdersServiceImpl.java` - 业务实现
- `OrdersController.java` - 控制器

### 前端
- `orderStore.js` - 订单状态管理
- `Checkout.vue` - 订单确认页面

## 测试验证

1. 选择有SKU的商品，验证结算页面价格与SKU价格一致
2. 提交订单并自动支付，验证支付成功
3. 验证订单详情中的单价与SKU价格一致
4. 验证订单总金额计算正确
